pipeline {
    // ğŸ¯ æŒ‡å®šæ‰§è¡Œç¯å¢ƒ
    agent any
    
    // ğŸ”§ å…¨å±€å·¥å…·é…ç½®
    tools {
        maven 'Maven-3.8'
        jdk 'JDK-11'
    }
    
    // ğŸŒ ç¯å¢ƒå˜é‡
    environment {
        APP_NAME = 'my-application'
        VERSION = '1.0.0'
        DOCKER_REGISTRY = 'registry.company.com'
    }
    
    // âš™ï¸ å‚æ•°åŒ–æ„å»º
    parameters {
        choice(
            name: 'ENVIRONMENT',
            choices: ['dev', 'test', 'prod'],
            description: 'é€‰æ‹©éƒ¨ç½²ç¯å¢ƒ'
        )
        booleanParam(
            name: 'SKIP_TESTS',
            defaultValue: false,
            description: 'æ˜¯å¦è·³è¿‡æµ‹è¯•'
        )
        string(
            name: 'BRANCH_NAME',
            defaultValue: 'main',
            description: 'æŒ‡å®šåˆ†æ”¯'
        )
    }
    
    // ğŸ”„ å®šæ—¶è§¦å‘
    triggers {
        cron('H 2 * * 1-5')  // å·¥ä½œæ—¥å‡Œæ™¨2ç‚¹
        pollSCM('H/5 * * * *')  // æ¯5åˆ†é’Ÿæ£€æŸ¥ä»£ç å˜æ›´
    }
    
    // ğŸ“‹ æ„å»ºé˜¶æ®µ
    stages {
        stage('ç¯å¢ƒæ£€æŸ¥') {
            steps {
                script {
                    echo "æ„å»ºç¯å¢ƒ: ${params.ENVIRONMENT}"
                    echo "åº”ç”¨åç§°: ${env.APP_NAME}"
                    echo "Javaç‰ˆæœ¬: ${env.JAVA_HOME}"
                }
            }
        }
        
        stage('ä»£ç æ£€å‡º') {
            steps {
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: "*/${params.BRANCH_NAME}"]],
                    userRemoteConfigs: [[
                        url: 'https://github.com/your-repo.git',
                        credentialsId: 'github-credentials'
                    ]]
                ])
            }
        }
        
        stage('ä¾èµ–å®‰è£…') {
            steps {
                sh 'mvn clean compile'
            }
        }
        
        stage('ä»£ç è´¨é‡æ£€æŸ¥') {
            parallel {
                stage('å•å…ƒæµ‹è¯•') {
                    when {
                        not { params.SKIP_TESTS }
                    }
                    steps {
                        sh 'mvn test'
                    }
                    post {
                        always {
                            junit 'target/surefire-reports/*.xml'
                            publishHTML([
                                allowMissing: false,
                                alwaysLinkToLastBuild: true,
                                keepAll: true,
                                reportDir: 'target/site/jacoco',
                                reportFiles: 'index.html',
                                reportName: 'ä»£ç è¦†ç›–ç‡æŠ¥å‘Š'
                            ])
                        }
                    }
                }
                
                stage('ä»£ç æ‰«æ') {
                    steps {
                        script {
                            def scannerHome = tool 'SonarQube Scanner'
                            withSonarQubeEnv('SonarQube') {
                                sh """
                                    ${scannerHome}/bin/sonar-scanner \
                                    -Dsonar.projectKey=${env.APP_NAME} \
                                    -Dsonar.sources=src/main/java \
                                    -Dsonar.java.binaries=target/classes
                                """
                            }
                        }
                    }
                }
            }
        }
        
        stage('æ„å»ºæ‰“åŒ…') {
            steps {
                sh 'mvn package -DskipTests'
                archiveArtifacts artifacts: 'target/*.jar', fingerprint: true
            }
        }
        
        stage('Dockeræ„å»º') {
            steps {
                script {
                    def image = docker.build("${env.DOCKER_REGISTRY}/${env.APP_NAME}:${env.VERSION}")
                    docker.withRegistry("https://${env.DOCKER_REGISTRY}", 'docker-registry-credentials') {
                        image.push()
                        image.push('latest')
                    }
                }
            }
        }
        
        stage('éƒ¨ç½²') {
            when {
                anyOf {
                    branch 'main'
                    expression { params.ENVIRONMENT == 'prod' }
                }
            }
            steps {
                script {
                    switch(params.ENVIRONMENT) {
                        case 'dev':
                            deployToEnvironment('dev', '8080')
                            break
                        case 'test':
                            deployToEnvironment('test', '8081')
                            break
                        case 'prod':
                            input message: 'ç¡®è®¤éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼Ÿ', ok: 'éƒ¨ç½²'
                            deployToEnvironment('prod', '8082')
                            break
                    }
                }
            }
        }
    }
    
    // ğŸ“Š æ„å»ºåå¤„ç†
    post {
        always {
            echo 'æ„å»ºå®Œæˆï¼Œæ¸…ç†å·¥ä½œç©ºé—´'
            cleanWs()
        }
        success {
            emailext (
                to: 'team@company.com',
                subject: "âœ… æ„å»ºæˆåŠŸ: ${env.JOB_NAME} - ${env.BUILD_NUMBER}",
                body: """
                    æ„å»ºæˆåŠŸï¼
                    
                    é¡¹ç›®: ${env.JOB_NAME}
                    æ„å»ºå·: ${env.BUILD_NUMBER}
                    åˆ†æ”¯: ${params.BRANCH_NAME}
                    ç¯å¢ƒ: ${params.ENVIRONMENT}
                    
                    æŸ¥çœ‹è¯¦æƒ…: ${env.BUILD_URL}
                """
            )
        }
        failure {
            emailext (
                to: 'team@company.com',
                subject: "âŒ æ„å»ºå¤±è´¥: ${env.JOB_NAME} - ${env.BUILD_NUMBER}",
                body: """
                    æ„å»ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—ï¼
                    
                    é¡¹ç›®: ${env.JOB_NAME}
                    æ„å»ºå·: ${env.BUILD_NUMBER}
                    
                    æŸ¥çœ‹æ—¥å¿—: ${env.BUILD_URL}console
                """
            )
        }
        unstable {
            echo 'æ„å»ºä¸ç¨³å®šï¼Œå¯èƒ½æµ‹è¯•å¤±è´¥'
        }
    }
}

// ğŸ”§ è‡ªå®šä¹‰å‡½æ•°
def deployToEnvironment(environment, port) {
    echo "éƒ¨ç½²åˆ° ${environment} ç¯å¢ƒï¼Œç«¯å£: ${port}"
    
    sh """
        docker stop ${env.APP_NAME}-${environment} || true
        docker rm ${env.APP_NAME}-${environment} || true
        docker run -d \
            --name ${env.APP_NAME}-${environment} \
            -p ${port}:8080 \
            ${env.DOCKER_REGISTRY}/${env.APP_NAME}:${env.VERSION}
    """
    
    // å¥åº·æ£€æŸ¥
    timeout(time: 5, unit: 'MINUTES') {
        waitUntil {
            script {
                def response = sh(
                    script: "curl -s -o /dev/null -w '%{http_code}' http://localhost:${port}/health",
                    returnStdout: true
                ).trim()
                return response == '200'
            }
        }
    }
    
    echo "âœ… ${environment} ç¯å¢ƒéƒ¨ç½²æˆåŠŸï¼ŒæœåŠ¡å·²å¯åŠ¨"
}