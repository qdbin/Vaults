# Jenkins + GitLab CI/CD ç¯å¢ƒ - ä¼˜åŒ–ç‰ˆæœ¬

## ğŸ“‹ æ¦‚è¿°

æœ¬é…ç½®åŸºäº [åŸå§‹ç½‘ç«™æ–¹æ¡ˆ](https://www.cnblogs.com/wbourne/p/17035591.html) è¿›è¡Œäº†æ·±åº¦ä¼˜åŒ–ï¼Œç»“åˆäº†Docker Composeçš„ä¾¿åˆ©æ€§å’Œç½‘ç«™æ–¹æ¡ˆçš„å®ç”¨æ€§ï¼Œæä¾›äº†ä¸€ä¸ªå®Œæ•´çš„CI/CDå­¦ä¹ å’Œå®è·µç¯å¢ƒã€‚

## ğŸ¯ æ ¸å¿ƒä¼˜åŒ–

### 1. ä¸¥æ ¼å‚è€ƒç½‘ç«™é…ç½®
- **ç«¯å£é…ç½®**ï¼šå®Œå…¨é‡‡ç”¨ç½‘ç«™çš„ç«¯å£æ–¹æ¡ˆï¼ˆJenkins: 37808, GitLab: 35080, App: 31808ï¼‰
- **ç½‘ç»œé…ç½®**ï¼šä½¿ç”¨ç›¸åŒçš„å­ç½‘é…ç½®ï¼ˆ172.12.0.0/16ï¼‰
- **å®¹å™¨å‘½å**ï¼šä¿æŒä¸ç½‘ç«™ä¸€è‡´çš„å‘½åè§„èŒƒ

### 2. æå–å…¬å…±é…ç½®
```yaml
# å…¬å…±ç¯å¢ƒå˜é‡
x-common-variables: &common-variables
  TZ: Asia/Shanghai
  LANG: en_US.UTF-8

# å…¬å…±é‡å¯ç­–ç•¥
x-restart-policy: &restart-policy
  restart: unless-stopped

# å…¬å…±ç½‘ç»œé…ç½®
x-network-config: &network-config
  networks:
    - ci-cd-network
```

### 3. ç§»é™¤ä¸å¿…è¦çš„æœåŠ¡
- **ç§»é™¤Nginx**ï¼šå‚è€ƒç½‘ç«™æ–¹æ¡ˆï¼Œä¸“æ³¨äºCI/CDæ ¸å¿ƒæµç¨‹
- **ç®€åŒ–æ¶æ„**ï¼šåªä¿ç•™Jenkinsã€GitLabã€Appä¸‰ä¸ªæ ¸å¿ƒå®¹å™¨

### 4. ä¼˜åŒ–é…ç½®ç»†èŠ‚
- **å¥åº·æ£€æŸ¥**ï¼šä¸ºæ‰€æœ‰æœåŠ¡æ·»åŠ å¥åº·æ£€æŸ¥
- **èµ„æºä¼˜åŒ–**ï¼šGitLabå†…å­˜ä¼˜åŒ–ï¼Œç¦ç”¨ä¸å¿…è¦çš„æœåŠ¡
- **é•œåƒåŠ é€Ÿ**ï¼šä½¿ç”¨é˜¿é‡Œäº‘é•œåƒæºåŠ é€Ÿè½¯ä»¶å®‰è£…

## ğŸ—ï¸ æ¶æ„è¯´æ˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Jenkins     â”‚    â”‚     GitLab      â”‚    â”‚   App Server    â”‚
â”‚   (CI/CD å¼•æ“)   â”‚    â”‚   (ä»£ç ä»“åº“)     â”‚    â”‚   (éƒ¨ç½²ç›®æ ‡)     â”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚ Port: 37808     â”‚    â”‚ Port: 35080     â”‚    â”‚ SSH: 31022      â”‚
â”‚ Agent: 37500    â”‚    â”‚ SSH: 35022      â”‚    â”‚ App: 31808      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   ci-cd-network     â”‚
                    â”‚  172.12.0.0/16      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å¯åŠ¨ç¯å¢ƒ
```bash
# å…‹éš†æˆ–ä¸‹è½½é…ç½®æ–‡ä»¶
cd /path/to/jenkins-gitlab-cicd

# å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose up -d

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps
```

### 2. è®¿é—®æœåŠ¡
- **Jenkins**: http://localhost:37808
- **GitLab**: http://localhost:35080
- **åº”ç”¨æœåŠ¡å™¨**: SSHè¿æ¥ localhost:31022 (root/password123)

### 3. åˆå§‹åŒ–é…ç½®

#### Jenkinsé…ç½®
```bash
# è·å–Jenkinsåˆå§‹å¯†ç 
docker exec jenkins cat /var/jenkins_home/secrets/initialAdminPassword

# å®‰è£…æ¨èæ’ä»¶ï¼š
# - Git plugin
# - SSH plugin
# - Pipeline plugin
# - GitLab plugin
```

#### GitLabé…ç½®
```bash
# è·å–GitLab rootå¯†ç 
docker exec gitlab grep 'Password:' /etc/gitlab/initial_root_password

# åˆ›å»ºé¡¹ç›®å¹¶é…ç½®WebHook
# è®¾ç½®SSHå¯†é’¥ç”¨äºä»£ç æ¨é€
```

## ğŸ“ ç›®å½•ç»“æ„

```
jenkins-gitlab-cicd/
â”œâ”€â”€ docker-compose.yml          # ä¸»é…ç½®æ–‡ä»¶
â”œâ”€â”€ README-optimized.md         # æœ¬æ–‡æ¡£
â”œâ”€â”€ scripts/                    # éƒ¨ç½²è„šæœ¬ç›®å½•
â”‚   â””â”€â”€ start.sh               # Javaåº”ç”¨å¯åŠ¨è„šæœ¬
â”œâ”€â”€ jenkins/                   # Jenkinsæ•°æ®ç›®å½•
â”œâ”€â”€ gitlab/                    # GitLabæ•°æ®ç›®å½•
â”‚   â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ logs/
â”‚   â””â”€â”€ data/
â””â”€â”€ app/                       # åº”ç”¨éƒ¨ç½²ç›®å½•
```

## ğŸ”§ é…ç½®è¯¦è§£

### ç½‘ç»œé…ç½®è¯´æ˜
```yaml
networks:
  ci-cd-network:                # è‡ªå®šä¹‰ç½‘ç»œåç§°ï¼ˆå¯ä¿®æ”¹ï¼‰
    driver: bridge              # æ¡¥æ¥ç½‘ç»œé©±åŠ¨ï¼ˆå›ºå®šï¼‰
    ipam:                      # IPåœ°å€ç®¡ç†ï¼ˆå›ºå®šå­—æ®µï¼‰
      driver: default           # é»˜è®¤IPAMé©±åŠ¨ï¼ˆå›ºå®šï¼‰
      config:
        - subnet: 172.12.0.0/16 # å­ç½‘é…ç½®ï¼ˆå¯ä¿®æ”¹ï¼‰
          gateway: 172.12.0.1   # ç½‘å…³é…ç½®ï¼ˆå¯ä¿®æ”¹ï¼‰
```

### æ•°æ®å·è¯´æ˜
- **ç»‘å®šæŒ‚è½½**ï¼šä½¿ç”¨ `./jenkins:/var/jenkins_home` å½¢å¼
- **ä¼˜åŠ¿**ï¼šä¾¿äºå¤‡ä»½ã€è¿ç§»å’Œç›´æ¥è®¿é—®æ–‡ä»¶
- **æ³¨æ„**ï¼šæ— éœ€æ‰‹åŠ¨åˆ›å»ºï¼ŒDockerä¼šè‡ªåŠ¨åˆ›å»ºç›®å½•

### æ³¨é‡Šè¯´æ˜
- YAMLæ–‡ä»¶ä¸­çš„ `#` æ³¨é‡Šä¸å½±å“æ‰§è¡Œ
- è¯¦ç»†æ³¨é‡Šå¸®åŠ©ç†è§£æ¯ä¸ªé…ç½®é¡¹çš„ä½œç”¨

## ğŸ”„ CI/CD æµç¨‹

### å®Œæ•´æµç¨‹ç¤ºä¾‹
1. **ä»£ç æäº¤** â†’ GitLabä»“åº“
2. **WebHookè§¦å‘** â†’ Jenkinsæ„å»º
3. **è‡ªåŠ¨æ„å»º** â†’ Maven/Gradleæ‰“åŒ…
4. **è‡ªåŠ¨éƒ¨ç½²** â†’ SSHæ¨é€åˆ°Appå®¹å™¨
5. **æœåŠ¡é‡å¯** â†’ ä½¿ç”¨start.shè„šæœ¬

### Jenkins Pipelineç¤ºä¾‹
```groovy
pipeline {
    agent any
    stages {
        stage('Checkout') {
            steps {
                git 'http://gitlab:80/root/your-project.git'
            }
        }
        stage('Build') {
            steps {
                sh 'mvn clean package'
            }
        }
        stage('Deploy') {
            steps {
                sh '''
                    scp target/*.jar root@app:/root/app/
                    ssh root@app "cd /root/scripts && ./start.sh"
                '''
            }
        }
    }
}
```

## ğŸ†š ä¸åŸæ–¹æ¡ˆå¯¹æ¯”

| ç‰¹æ€§ | åŸç½‘ç«™æ–¹æ¡ˆ | æœ¬ä¼˜åŒ–æ–¹æ¡ˆ | ä¼˜åŠ¿ |
|------|------------|------------|------|
| éƒ¨ç½²æ–¹å¼ | æ‰‹åŠ¨Dockerå‘½ä»¤ | Docker Compose | ä¸€é”®å¯åŠ¨ï¼Œé…ç½®ç»Ÿä¸€ |
| é…ç½®ç®¡ç† | åˆ†æ•£çš„å‘½ä»¤å‚æ•° | é›†ä¸­çš„YAMLé…ç½® | æ˜“äºç»´æŠ¤å’Œç‰ˆæœ¬æ§åˆ¶ |
| ç½‘ç»œé…ç½® | æ‰‹åŠ¨åˆ›å»ºç½‘ç»œ | è‡ªåŠ¨åˆ›å»ºç½‘ç»œ | ç®€åŒ–æ“ä½œæµç¨‹ |
| ç«¯å£é…ç½® | ä¸ç½‘ç«™å®Œå…¨ä¸€è‡´ | ä¸ç½‘ç«™å®Œå…¨ä¸€è‡´ | ä¿æŒå…¼å®¹æ€§ |
| æ–‡æ¡£å®Œæ•´æ€§ | åŸºç¡€è¯´æ˜ | è¯¦ç»†æ³¨é‡Š+æ–‡æ¡£ | ä¾¿äºå­¦ä¹ å’Œç†è§£ |

## ğŸ› ï¸ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **ç«¯å£å†²çª**
   ```bash
   # æ£€æŸ¥ç«¯å£å ç”¨
   netstat -tulpn | grep :37808
   
   # ä¿®æ”¹docker-compose.ymlä¸­çš„ç«¯å£æ˜ å°„
   ```

2. **å®¹å™¨å¯åŠ¨å¤±è´¥**
   ```bash
   # æŸ¥çœ‹å®¹å™¨æ—¥å¿—
   docker-compose logs jenkins
   docker-compose logs gitlab
   docker-compose logs app-server
   ```

3. **SSHè¿æ¥å¤±è´¥**
   ```bash
   # æ£€æŸ¥appå®¹å™¨SSHæœåŠ¡
   docker exec app-server pgrep sshd
   
   # é‡å¯SSHæœåŠ¡
   docker exec app-server service ssh restart
   ```

4. **GitLabå†…å­˜ä¸è¶³**
   ```bash
   # è°ƒæ•´GitLabå†…å­˜é…ç½®
   # åœ¨docker-compose.ymlä¸­ä¿®æ”¹GITLAB_OMNIBUS_CONFIG
   ```

## ğŸ“š å­¦ä¹ å»ºè®®

1. **ç†è§£é…ç½®**ï¼šä»”ç»†é˜…è¯»docker-compose.ymlä¸­çš„æ³¨é‡Š
2. **å®è·µæ“ä½œ**ï¼šæŒ‰ç…§CI/CDæµç¨‹å®Œæ•´èµ°ä¸€é
3. **è‡ªå®šä¹‰é…ç½®**ï¼šæ ¹æ®å®é™…éœ€æ±‚è°ƒæ•´ç«¯å£ã€ç½‘ç»œç­‰é…ç½®
4. **ç›‘æ§æ—¥å¿—**ï¼šå­¦ä¼šä½¿ç”¨docker-compose logsæ’æŸ¥é—®é¢˜

## ğŸ”— ç›¸å…³èµ„æº

- [åŸå§‹å‚è€ƒç½‘ç«™](https://www.cnblogs.com/wbourne/p/17035591.html)
- [Docker Composeå®˜æ–¹æ–‡æ¡£](https://docs.docker.com/compose/)
- [Jenkinså®˜æ–¹æ–‡æ¡£](https://www.jenkins.io/doc/)
- [GitLab CEæ–‡æ¡£](https://docs.gitlab.com/ee/)

---

**æ³¨æ„**ï¼šæœ¬é…ç½®ä¸“ä¸ºå­¦ä¹ å’Œå¼€å‘ç¯å¢ƒè®¾è®¡ï¼Œç”Ÿäº§ç¯å¢ƒä½¿ç”¨è¯·æ ¹æ®å®é™…éœ€æ±‚è¿›è¡Œå®‰å…¨åŠ å›ºã€‚